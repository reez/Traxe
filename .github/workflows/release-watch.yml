name: Release watch

on:
  schedule:
    - cron: "0 15 * * 1"
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    strategy:
      matrix:
        include:
          - repo: bitaxeorg/ESP-Miner
            title: "Release Watch: bitaxeorg/ESP-Miner"
            include_prereleases: true
          - repo: shufps/ESP-Miner-NerdQAxePlus
            title: "Release Watch: shufps/ESP-Miner-NerdQAxePlus"
            include_prereleases: true
    steps:
      - uses: actions/checkout@v4

      - name: Generate report
        id: generate
        run: >-
          python3 .github/scripts/release_watch.py
          --repo "${{ matrix.repo }}"
          --days 7
          ${{ matrix.include_prereleases && '--include-prereleases' || '' }}
          --output report.md

      - name: Post report to issue
        if: steps.generate.outputs.has_releases == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('report.md', 'utf8');
            const title = '${{ matrix.title }}';
            const { owner, repo } = context.repo;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });

            const issue = issues.find((item) => !item.pull_request && item.title === title);
            if (!issue) {
              await github.rest.issues.create({ owner, repo, title, body });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body,
              });
            }
